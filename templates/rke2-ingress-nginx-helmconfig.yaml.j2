apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: rke2-ingress-nginx
  namespace: kube-system
spec:
  valuesContent: |-
    controller:
      kind: DaemonSet
      hostNetwork: {{ (rke2_ingress_hostNetwork | default(true)) | bool }}
      dnsPolicy: {{ rke2_ingress_dnsPolicy | default('ClusterFirstWithHostNet') }}

      # Use existing IngressClass by name; DO NOT create/manage the resource
      ingressClass: {{ rke2_ingress_class_name | default('public') }}
      ingressClassByName: true
      ingressClassResource:
        enabled: false

      watchIngressWithoutClass: {{ (rke2_ingress_watch_without_class | default(false)) | bool }}

      # Run on ALL linux nodes (servers + agents). Avoid worker=true equality.
      nodeSelector:
{% for k, v in (rke2_ingress_node_selector | default({'kubernetes.io/os':'linux'})).items() %}
        {{ k }}: "{{ v }}"
{% endfor %}

      # Tolerate control-plane taints so it schedules on servers, too.
      tolerations:
{% set user_tols = (rke2_ingress_tolerations | default([])) %}
{% if user_tols | length > 0 %}
{%   for t in user_tols %}
        - {{ t | to_nice_yaml(indent=10) | trim }}
{%   endfor %}
{% else %}
        # (none provided by user)
{% endif %}
        # ensure control-plane taints are tolerated
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/master"
          operator: "Exists"
          effect: "NoSchedule"